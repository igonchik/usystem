#!/bin/bash

#Create group
echo "select email from pubview.usystem_user_view where username like '$USER';" | psql -d usystem --no-align --tuples-only | while read Record ; do
email=$Record;
username=$USER;
group=$1;
groupadd $group
usermod -a -G $group $username
mkdir /home/$username/$group/
mkdir /home/$username/$group/newcerts
mkdir /home/$username/$group/certs
mkdir /home/$username/$group/p12
mkdir /home/$username/$group/reqs
mkdir /home/$username/$group/private
touch /home/$username/$group/index.txt
touch /home/$username/$group/index.txt.attr
echo '01' > /home/$username/$group/crlnumber
echo '01' > /home/$username/$group/serial
chown -R $username:$group /home/$username/$group/
chmod 0750 /home/$username/$group/
cp /etc/ssl/openssl.cnf_def /home/$username/$group/openssl.cnf
sed -i -e "s/testuser/$username/g" -e "s/testgroup/$username/g" /home/$username/$group/openssl.cnf
chmod 0440 /home/$username/$group/openssl.cnf
chown $username:$group /home/$username/$group/openssl.cnf

#Crypto path
#Create Master CA
openssl genrsa -des3 -passout pass:$pass -out /home/$username/$group/private/ca.key 4096 1>&2 2>/dev/null
openssl req -x509 -new -sha256 -days 1825 -key /home/$username/$group/private/ca.key -out /home/$username/$group/cacert.pem -subj "/C=RU/O=$group/CN=$group/emailAddress=$email" -passin pass:$pass
openssl ca -config /home/$username/$group/openssl.cnf -gencrl -passin pass:$pass -out /home/$username/$group/cacrl.pem
chmod 0640 /home/$username/$group/private/ca.key
chown $username:$group /home/$username/$group/private/ca.key
chmod 0640 /home/$username/$group/cacert.pem
chown $username:$group /home/$username/$group/cacert.pem
chmod 0640 /home/$username/$group/cacrl.pem
chown $username:$group /home/$username/$group/cacrl.pem
#Generate master admin
openssl genrsa -des3 -passout pass:$pass -out /home/$username/$group/private/$username.key 4096 1>&2 2>/dev/null
openssl req -new -key /home/$username/$group/private/$username.key -out /home/$username/$group/reqs/$username.req -passin pass:$pass -subj "/C=RU/O=$group/CN=$username/emailAddress=$email"
openssl ca -config /home/$username/$group/openssl.cnf -batch -days 90 -notext -md sha256 -in /home/$username/$group/reqs/$username.req -out /home/$username/$group/certs/$username.pem -passin pass:$pass 1>&2 2>/dev/null
chmod 0640 /home/$username/$group/private/$username.key
chown $username:$group /home/$username/$group/private/$username.key
chmod 0640 /home/$username/$group/certs/$username.pem
chown $username:$group /home/$username/$group/certs/$username.pem
openssl pkcs12 -export -out /home/$username/$group/p12/$username.p12 -inkey /home/$username/$group/private/$username.key -in /home/$username/$group/certs/$username.pem -passin pass:$pass -passout pass:$pass 1>&2 2>/dev/null
chmod 0640 /home/$username/$group/p12/$username.p12
chown $username:$group /home/$username/$group/p12/$username.p12

chown $username:$group  /home/$username/$group/crl*
chown $username:$group  /home/$username/$group/index*
chown $username:$group  /home/$username/$group/serial*

chmod g+s /home/$username/
chmod g+s /home/$username/$group/
chmod g+s /home/$username/$group/newcerts
chmod g+s /home/$username/$group/certs
chmod g+s /home/$username/$group/p12
chmod g+s /home/$username/$group/reqs
chmod g+s /home/$username/$group/private
setfacl -d -m u::rwx /home/$username/
setfacl -d -m u::rwx /home/$username/$group/newcerts
setfacl -d -m u::rwx /home/$username/$group/certs
setfacl -d -m u::rwx /home/$username/$group/p12
setfacl -d -m u::rwx /home/$username/$group/reqs
setfacl -d -m u::rwx /home/$username/$group/private
setfacl -d -m u::rwx /home/$username/$group/
setfacl -d -m g::rx /home/$username/
setfacl -d -m g::rx /home/$username/$group/
setfacl -d -m g::rx /home/$username/$group/newcerts
setfacl -d -m g::rx /home/$username/$group/certs
setfacl -d -m g::rx /home/$username/$group/p12
setfacl -d -m g::rx /home/$username/$group/reqs
setfacl -d -m g::rx /home/$username/$group/private
done
